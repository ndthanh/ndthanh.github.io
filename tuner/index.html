<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>BalanceBot PID Tuner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: #0a0e27;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 12px;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at top, rgba(13, 110, 253, 0.15), transparent 50%),
                radial-gradient(ellipse at bottom, rgba(220, 53, 69, 0.15), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            background: rgba(15, 20, 40, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(13, 110, 253, 0.3);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            padding: 16px 20px;
            max-width: 1100px;
            width: 100%;
            height: calc(100vh - 24px);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* ===== TOOLBAR ===== */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .toolbar-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 900;
            background: linear-gradient(135deg, #0d6efd, #6610f2, #d63384);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* ===== TAB BUTTONS ===== */
        .tab-btn {
            padding: 4px 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 5px;
            background: transparent;
            font-family: 'Orbitron', sans-serif;
            font-size: 8px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: rgba(13, 110, 253, 0.2);
            border-color: rgba(13, 110, 253, 0.5);
            color: #0d6efd;
        }

        .tab-btn:hover:not(.active) {
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.6);
        }

        .tab-content {
            display: none;
            flex: 1;
            min-height: 0;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .status-badge {
            font-family: 'Orbitron', sans-serif;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #dc3545;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .status-badge.connected {
            background: rgba(25, 135, 84, 0.2);
            border-color: rgba(25, 135, 84, 0.6);
            color: #198754;
            box-shadow: 0 0 10px rgba(25, 135, 84, 0.3);
        }

        .tbtn {
            padding: 5px 12px;
            border: none;
            border-radius: 6px;
            font-family: 'Orbitron', sans-serif;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tbtn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .tbtn-connect {
            background: linear-gradient(135deg, #0d6efd, #6610f2);
            color: white;
        }

        .tbtn-zero {
            background: linear-gradient(135deg, #198754, #20c997);
            color: white;
        }

        .toolbar-sep {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.15);
            flex-shrink: 0;
        }

        /* Movement D-pad in toolbar */
        .move-pad {
            display: grid;
            grid-template-columns: repeat(3, 28px);
            grid-template-rows: repeat(3, 28px);
            gap: 3px;
            flex-shrink: 0;
        }

        .move-pad .mbtn {
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            padding: 0;
        }

        .move-pad .mbtn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .move-pad .mbtn.dir {
            background: rgba(13, 110, 253, 0.2);
            border: 1px solid rgba(13, 110, 253, 0.4);
            color: #0d6efd;
        }

        .move-pad .mbtn.dir:active:not(:disabled),
        .move-pad .mbtn.dir.active {
            background: #0d6efd;
            color: white;
        }

        .move-pad .mbtn.stp {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.4);
            color: #dc3545;
            font-size: 10px;
        }

        .move-pad .empty {
            background: transparent;
            border: none;
        }

        /* Teleplot toggle compact */
        .tele-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .tele-toggle .tsw {
            position: relative;
            width: 32px;
            height: 18px;
        }

        .tele-toggle .tsw input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .tele-toggle .tsl {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            transition: 0.3s;
        }

        .tele-toggle .tsl:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .tele-toggle .tsw input:checked+.tsl {
            background: linear-gradient(135deg, #0d6efd, #6610f2);
        }

        .tele-toggle .tsw input:checked+.tsl:before {
            transform: translateX(14px);
        }

        .toolbar-spacer {
            flex: 1;
        }

        .tuner-toolbar {
            display: contents;
        }

        .tuner-toolbar.hidden {
            display: none;
        }

        /* Error & zero info */
        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #dc3545;
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 11px;
            display: none;
            flex-shrink: 0;
        }

        .error.show {
            display: block;
        }

        .zero-info {
            background: rgba(25, 135, 84, 0.15);
            border: 1px solid rgba(25, 135, 84, 0.4);
            color: #20c997;
            padding: 4px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 9px;
            letter-spacing: 1px;
            text-align: center;
            flex-shrink: 0;
        }

        /* ===== MAIN LAYOUT ===== */
        .main {
            display: flex;
            gap: 16px;
            flex: 1;
            min-height: 0;
        }

        .col-left {
            width: 280px;
            flex-shrink: 0;
            overflow-y: auto;
            padding-right: 4px;
        }

        /* Thin scrollbar */
        .col-left::-webkit-scrollbar {
            width: 3px;
        }

        .col-left::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        .col-right {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        /* ===== PID SECTIONS (compact) ===== */
        .sec-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            font-weight: 700;
            color: #0d6efd;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(13, 110, 253, 0.25);
        }

        .sec {
            margin-bottom: 12px;
        }

        .pg {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 6px 8px;
            margin-bottom: 4px;
        }

        .pg-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
        }

        .pg-val {
            font-family: 'Orbitron', sans-serif;
            color: #0d6efd;
            font-size: 11px;
            font-weight: 700;
        }

        .slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0d6efd, #6610f2);
            cursor: pointer;
        }

        .slider:disabled {
            opacity: 0.3;
        }

        /* ===== CHARTS (stacked) ===== */
        .charts-stack {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 0;
        }

        .mini-chart {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 4px 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 0;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .mini-chart.saturated {
            border-color: rgba(220, 53, 69, 0.7);
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
        }

        .mini-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .mini-chart-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .mini-chart-val {
            font-family: 'Orbitron', sans-serif;
            font-size: 9px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .mini-chart-canvas {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .chart-dt {
            font-family: 'Orbitron', sans-serif;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 1px;
            margin-left: 8px;
        }

        .sat-badge {
            display: none;
            position: absolute;
            top: 4px;
            left: 8px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 8px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            letter-spacing: 1px;
        }

        .mini-chart.saturated .sat-badge {
            display: block;
        }

        /* ===== OTA TAB ===== */
        .ota-panel {
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        .ota-file-drop {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 16px;
        }

        .ota-file-drop:hover,
        .ota-file-drop.dragover {
            border-color: rgba(13, 110, 253, 0.5);
            background: rgba(13, 110, 253, 0.05);
        }

        .ota-file-drop.has-file {
            border-color: rgba(25, 135, 84, 0.5);
            background: rgba(25, 135, 84, 0.05);
        }

        .ota-file-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .ota-file-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
        }

        .ota-file-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            color: #20c997;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        .ota-progress {
            margin-bottom: 16px;
        }

        .ota-progress-bg {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .ota-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0d6efd, #20c997);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }

        .ota-progress-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            letter-spacing: 1px;
        }

        .ota-upload-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #198754, #20c997);
            color: white;
            font-size: 11px;
            margin-bottom: 16px;
        }

        .ota-log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px;
            max-height: 240px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .ota-log::-webkit-scrollbar {
            width: 3px;
        }

        .ota-log::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        .ota-log-entry {
            color: rgba(255, 255, 255, 0.4);
        }

        .ota-log-entry.info {
            color: #4dabf7;
        }

        .ota-log-entry.success {
            color: #20c997;
        }

        .ota-log-entry.error {
            color: #dc3545;
        }

        /* ===== PROFILES ===== */
        .prof-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }

        .prof-bar .tbtn {
            flex: 1;
            font-size: 8px;
            padding: 4px 6px;
        }

        .prof-save-form {
            display: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(13, 110, 253, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
        }

        .prof-save-form.show {
            display: block;
        }

        .prof-input {
            width: 100%;
            padding: 5px 8px;
            margin-bottom: 4px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            color: #e2e8f0;
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            outline: none;
        }

        .prof-input:focus {
            border-color: rgba(13, 110, 253, 0.5);
        }

        .prof-input::placeholder {
            color: rgba(255, 255, 255, 0.25);
        }

        .prof-save-btns {
            display: flex;
            gap: 4px;
        }

        .prof-save-btns .tbtn {
            flex: 1;
            font-size: 8px;
            padding: 4px 6px;
        }

        .prof-list {
            max-height: 160px;
            overflow-y: auto;
        }

        .prof-list::-webkit-scrollbar {
            width: 3px;
        }

        .prof-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        .prof-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 6px 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prof-item:hover {
            border-color: rgba(13, 110, 253, 0.3);
        }

        .prof-item-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 9px;
            font-weight: 700;
            color: #0d6efd;
            letter-spacing: 0.5px;
        }

        .prof-item-desc {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 2px;
            line-height: 1.3;
        }

        .prof-item-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .prof-item-actions .tbtn {
            font-size: 7px;
            padding: 2px 8px;
        }

        .prof-item.loading {
            border-color: rgba(25, 135, 84, 0.5);
            background: rgba(25, 135, 84, 0.05);
        }

        .prof-empty {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.25);
            text-align: center;
            padding: 8px;
        }

        .prof-active {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid rgba(13, 110, 253, 0.3);
            border-radius: 6px;
            padding: 5px 8px;
            margin-bottom: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 8px;
            font-weight: 700;
            color: #0d6efd;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .prof-loaded-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(25, 135, 84, 0.9);
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 8px 20px;
            border-radius: 8px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .prof-loaded-toast.show {
            opacity: 1;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            body {
                height: auto;
                overflow: auto;
            }

            .container {
                height: auto;
            }

            .toolbar {
                flex-wrap: wrap;
            }

            .main {
                flex-direction: column;
            }

            .col-left {
                width: 100%;
                overflow-y: visible;
            }

            .mini-chart-canvas {
                min-height: 80px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <span class="toolbar-title">BalanceBot</span>
            <button
                class="tab-btn active"
                data-tab="tuner"
            >Tuner</button>
            <button
                class="tab-btn"
                data-tab="ota"
            >OTA</button>
            <div
                id="statusBadge"
                class="status-badge"
            ><span id="statusText">OFFLINE</span></div>
            <button
                id="connectBtn"
                class="tbtn tbtn-connect"
            >Connect</button>
            <span
                id="tunerToolbar"
                class="tuner-toolbar"
            >
                <button
                    id="zeroBtn"
                    class="tbtn tbtn-zero"
                    disabled
                >Zero</button>
                <button
                    id="clearBtn"
                    class="tbtn"
                    style="background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6)"
                    onclick="clearChart(); _teleLogCount=0;"
                >Clear</button>
                <div class="toolbar-sep"></div>
                <div class="move-pad">
                    <div class="empty"></div>
                    <button
                        id="btnFwd"
                        class="mbtn dir"
                        disabled
                    >&#9650;</button>
                    <div class="empty"></div>
                    <button
                        id="btnLeft"
                        class="mbtn dir"
                        disabled
                    >&#9664;</button>
                    <button
                        id="btnStop"
                        class="mbtn stp"
                        disabled
                    >&#9632;</button>
                    <button
                        id="btnRight"
                        class="mbtn dir"
                        disabled
                    >&#9654;</button>
                    <div class="empty"></div>
                    <button
                        id="btnBack"
                        class="mbtn dir"
                        disabled
                    >&#9660;</button>
                    <div class="empty"></div>
                </div>
                <div class="toolbar-spacer"></div>
                <div class="tele-toggle">
                    <span>Teleplot</span>
                    <label class="tsw">
                        <input
                            type="checkbox"
                            id="teleplotToggle"
                            checked
                            disabled
                        >
                        <span class="tsl"></span>
                    </label>
                </div>
            </span>
        </div>

        <div
            id="error"
            class="error"
        ></div>
        <div
            id="zeroInfo"
            class="zero-info"
            style="display:none"
        ></div>

        <!-- TAB: TUNER -->
        <div
            id="tabTuner"
            class="tab-content active"
        >
            <div class="main">
                <div class="col-left">
                    <div
                        id="profActive"
                        class="prof-active"
                        style="display:none"
                    ></div>
                    <div class="sec">
                        <div class="sec-title">Pitch PID (Inner)</div>
                        <div class="pg">
                            <div class="pg-label"><span>Kp</span><span
                                    id="kpPitchVal"
                                    class="pg-val"
                                >0.60</span></div>
                            <input
                                type="range"
                                id="kpPitch"
                                class="slider"
                                min="0"
                                max="2"
                                step="0.01"
                                value="0.60"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Ki</span><span
                                    id="kiPitchVal"
                                    class="pg-val"
                                >0.000</span></div>
                            <input
                                type="range"
                                id="kiPitch"
                                class="slider"
                                min="0"
                                max="0.5"
                                step="0.001"
                                value="0"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Kd</span><span
                                    id="kdPitchVal"
                                    class="pg-val"
                                >0.00</span></div>
                            <input
                                type="range"
                                id="kdPitch"
                                class="slider"
                                min="0"
                                max="0.5"
                                step="0.005"
                                value="0"
                                disabled
                            >
                        </div>
                    </div>

                    <div class="sec">
                        <div class="sec-title">Velocity PID (Outer)</div>
                        <div class="pg">
                            <div class="pg-label"><span>Kp</span><span
                                    id="kpVelVal"
                                    class="pg-val"
                                >0.00</span></div>
                            <input
                                type="range"
                                id="kpVel"
                                class="slider"
                                min="0"
                                max="5"
                                step="0.01"
                                value="0"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Ki</span><span
                                    id="kiVelVal"
                                    class="pg-val"
                                >0.000</span></div>
                            <input
                                type="range"
                                id="kiVel"
                                class="slider"
                                min="0"
                                max="0.1"
                                step="0.001"
                                value="0"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Kd</span><span
                                    id="kdVelVal"
                                    class="pg-val"
                                >0.00</span></div>
                            <input
                                type="range"
                                id="kdVel"
                                class="slider"
                                min="0"
                                max="1"
                                step="0.01"
                                value="0"
                                disabled
                            >
                        </div>
                    </div>

                    <div class="sec">
                        <div class="sec-title">Advanced</div>
                        <div class="pg">
                            <div class="pg-label"><span>Max Torque (V)</span><span
                                    id="maxTorqueVal"
                                    class="pg-val"
                                >4.5</span></div>
                            <input
                                type="range"
                                id="maxTorque"
                                class="slider"
                                min="1"
                                max="8"
                                step="0.1"
                                value="4.5"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Slew (V/s)</span><span
                                    id="slewVal"
                                    class="pg-val"
                                >30</span></div>
                            <input
                                type="range"
                                id="slew"
                                class="slider"
                                min="10"
                                max="500"
                                step="10"
                                value="100"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Pos Kp</span><span
                                    id="posKpVal"
                                    class="pg-val"
                                >0.095</span></div>
                            <input
                                type="range"
                                id="posKp"
                                class="slider"
                                min="0"
                                max="1"
                                step="0.005"
                                value="0.095"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Steer Gain</span><span
                                    id="steerGainVal"
                                    class="pg-val"
                                >1.00</span></div>
                            <input
                                type="range"
                                id="steerGain"
                                class="slider"
                                min="0"
                                max="5"
                                step="0.1"
                                value="1.0"
                                disabled
                            >
                        </div>
                        <div class="pg">
                            <div class="pg-label"><span>Ctrl Freq (Hz)</span><span
                                    id="ctrlFreqVal"
                                    class="pg-val"
                                >200</span></div>
                            <input
                                type="range"
                                id="ctrlFreq"
                                class="slider"
                                min="50"
                                max="1000"
                                step="50"
                                value="200"
                                disabled
                            >
                        </div>
                    </div>

                    <div class="sec">
                        <div class="sec-title">Profiles</div>
                        <div class="prof-bar">
                            <button
                                class="tbtn"
                                style="background:linear-gradient(135deg,#0d6efd,#6610f2);color:white"
                                onclick="showSaveForm()"
                            >Save</button>
                        </div>
                        <div
                            id="profSaveForm"
                            class="prof-save-form"
                        >
                            <input
                                type="text"
                                id="profName"
                                class="prof-input"
                                placeholder="Profile name"
                                maxlength="40"
                            >
                            <input
                                type="text"
                                id="profDesc"
                                class="prof-input"
                                placeholder="Description (optional)"
                                maxlength="100"
                            >
                            <div class="prof-save-btns">
                                <button
                                    class="tbtn"
                                    style="background:linear-gradient(135deg,#198754,#20c997);color:white"
                                    onclick="saveProfile()"
                                >Confirm</button>
                                <button
                                    class="tbtn"
                                    style="background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.5)"
                                    onclick="hideSaveForm()"
                                >Cancel</button>
                            </div>
                        </div>
                        <div
                            id="profList"
                            class="prof-list"
                        ></div>
                    </div>
                </div>

                <div class="col-right">
                    <div class="sec-title">Telemetry <span
                            id="chartDt"
                            class="chart-dt"
                        ></span></div>
                    <div class="charts-stack">
                        <div
                            class="mini-chart"
                            id="chartPitch"
                        >
                            <span class="sat-badge">SAT</span>
                            <div class="mini-chart-header">
                                <span
                                    class="mini-chart-label"
                                    style="color:#4dabf7"
                                >Pitch</span>
                                <span
                                    id="livePitch"
                                    class="mini-chart-val"
                                >--</span>
                            </div>
                            <div class="mini-chart-canvas"><canvas id="canvasPitch"></canvas></div>
                        </div>
                        <div
                            class="mini-chart"
                            id="chartTorque"
                        >
                            <div class="mini-chart-header">
                                <span
                                    class="mini-chart-label"
                                    style="color:#ff6b6b"
                                >Torque</span>
                                <span
                                    id="liveTorque"
                                    class="mini-chart-val"
                                >--</span>
                            </div>
                            <div class="mini-chart-canvas"><canvas id="canvasTorque"></canvas></div>
                        </div>
                        <div
                            class="mini-chart"
                            id="chartVel"
                        >
                            <div class="mini-chart-header">
                                <span
                                    class="mini-chart-label"
                                    style="color:#51cf66"
                                >Velocity</span>
                                <span
                                    id="liveVel"
                                    class="mini-chart-val"
                                >--</span>
                            </div>
                            <div class="mini-chart-canvas"><canvas id="canvasVel"></canvas></div>
                        </div>
                        <div
                            class="mini-chart"
                            id="chartWpos"
                        >
                            <div class="mini-chart-header">
                                <span
                                    class="mini-chart-label"
                                    style="color:#fcc419"
                                >WheelPos</span>
                                <span
                                    id="liveWpos"
                                    class="mini-chart-val"
                                >--</span>
                            </div>
                            <div class="mini-chart-canvas"><canvas id="canvasWpos"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: OTA -->
        <div
            id="tabOta"
            class="tab-content"
        >
            <div class="ota-panel">
                <div
                    class="sec-title"
                    style="margin-bottom:16px"
                >Firmware Update (BLE OTA)</div>
                <div id="otaContent">
                    <div
                        class="ota-file-drop"
                        id="otaFileDrop"
                    >
                        <input
                            type="file"
                            id="otaFileInput"
                            accept=".bin"
                            style="display:none"
                        >
                        <div class="ota-file-icon">&#128230;</div>
                        <div
                            class="ota-file-text"
                            id="otaFileText"
                        >Click or drop firmware .bin file</div>
                        <div
                            id="otaFileName"
                            class="ota-file-name"
                        ></div>
                    </div>

                    <div
                        class="ota-progress"
                        id="otaProgressContainer"
                        style="display:none"
                    >
                        <div class="ota-progress-bg">
                            <div
                                class="ota-progress-bar"
                                id="otaProgressBar"
                            ></div>
                        </div>
                        <div
                            class="ota-progress-text"
                            id="otaProgressText"
                        >0%</div>
                    </div>

                    <button
                        id="otaUploadBtn"
                        class="tbtn ota-upload-btn"
                        disabled
                    >Upload Firmware</button>

                    <div
                        class="ota-log"
                        id="otaLog"
                    ></div>
                </div>
            </div>
        </div>
    </div>

    <div
        id="profToast"
        class="prof-loaded-toast"
    ></div>

    <script>
        // ==================== TUNER BLE UUIDs ====================
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const CHAR_CMD_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const CHAR_STATUS_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a9';
        const CHAR_DATA_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26aa';

        // ==================== OTA BLE UUIDs ====================
        const OTA_SERVICE_UUID = 'fb1e4001-54ae-4a28-9f74-dfccb248601d';
        const OTA_CONTROL_CHAR_UUID = 'fb1e4002-54ae-4a28-9f74-dfccb248601d';
        const OTA_DATA_CHAR_UUID = 'fb1e4003-54ae-4a28-9f74-dfccb248601d';

        const OTA_CMD_BEGIN = 0x01;
        const OTA_CMD_END = 0x02;
        const OTA_CMD_ABORT = 0x03;
        const OTA_STATUS_OK = 0x01;
        const OTA_STATUS_ERROR = 0x03;
        const OTA_CHUNK_SIZE = 512;

        let device = null, charCmd = null, charStatus = null, charData = null;
        let otaControlChar = null, otaDataChar = null;
        let otaHasService = false;

        const statusBadge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');
        const errorDiv = document.getElementById('error');
        const connectBtn = document.getElementById('connectBtn');
        const zeroBtn = document.getElementById('zeroBtn');
        const teleplotToggle = document.getElementById('teleplotToggle');

        const btnFwd = document.getElementById('btnFwd');
        const btnBack = document.getElementById('btnBack');
        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');
        const btnStop = document.getElementById('btnStop');

        const sliders = {
            kpPitch: { el: document.getElementById('kpPitch'), val: document.getElementById('kpPitchVal'), cmd: 'P', fmt: 2 },
            kiPitch: { el: document.getElementById('kiPitch'), val: document.getElementById('kiPitchVal'), cmd: 'I', fmt: 3 },
            kdPitch: { el: document.getElementById('kdPitch'), val: document.getElementById('kdPitchVal'), cmd: 'D', fmt: 2 },
            kpVel: { el: document.getElementById('kpVel'), val: document.getElementById('kpVelVal'), cmd: 'p', fmt: 2 },
            kiVel: { el: document.getElementById('kiVel'), val: document.getElementById('kiVelVal'), cmd: 'i', fmt: 3 },
            kdVel: { el: document.getElementById('kdVel'), val: document.getElementById('kdVelVal'), cmd: 'd', fmt: 2 },
            maxTorque: { el: document.getElementById('maxTorque'), val: document.getElementById('maxTorqueVal'), cmd: 'T', fmt: 1 },
            slew: { el: document.getElementById('slew'), val: document.getElementById('slewVal'), cmd: 'S', fmt: 0 },
            posKp: { el: document.getElementById('posKp'), val: document.getElementById('posKpVal'), cmd: 'h', fmt: 3 },
            steerGain: { el: document.getElementById('steerGain'), val: document.getElementById('steerGainVal'), cmd: 'G', fmt: 2 },
            ctrlFreq: { el: document.getElementById('ctrlFreq'), val: document.getElementById('ctrlFreqVal'), cmd: 'C', fmt: 0 }
        };

        if (!navigator.bluetooth) {
            showError('Web Bluetooth not supported. Use Chrome on desktop/Android.');
            connectBtn.disabled = true;
        }

        function showError(msg) {
            errorDiv.textContent = msg;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 4000);
        }

        function updateStatus(msg, connected) {
            statusText.textContent = msg;
            statusBadge.classList.toggle('connected', connected);
        }

        function enableControls(enabled) {
            Object.values(sliders).forEach(s => s.el.disabled = !enabled);
            zeroBtn.disabled = !enabled;
            btnFwd.disabled = !enabled;
            btnBack.disabled = !enabled;
            btnLeft.disabled = !enabled;
            btnRight.disabled = !enabled;
            btnStop.disabled = !enabled;
            teleplotToggle.disabled = !enabled;
        }

        // ==================== TABS ====================
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tunerToolbar = document.getElementById('tunerToolbar');

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            tabBtns.forEach(b => b.classList.remove('active'));
            document.getElementById(tabName === 'ota' ? 'tabOta' : 'tabTuner').classList.add('active');
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
            tunerToolbar.classList.toggle('hidden', tabName !== 'tuner');
            updateOtaUI();
        }

        tabBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));

        // ==================== TELEMETRY CHARTS (4 stacked) ====================
        const chartDt = document.getElementById('chartDt');
        const chartPitchEl = document.getElementById('chartPitch');
        const livePitch = document.getElementById('livePitch');
        const liveTorque = document.getElementById('liveTorque');
        const liveVel = document.getElementById('liveVel');
        const liveWpos = document.getElementById('liveWpos');

        const MAX_POINTS = 3000;
        let mcuTimeMs = 0;

        function makeMiniChart(canvasId, color, showXAxis) {
            return new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{ data: [], borderColor: color, borderWidth: 1.2, pointRadius: 0, tension: 0.2, fill: false }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            display: showXAxis,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 8 }, maxTicksLimit: 6, callback: function (v) { var s = this.getLabelForValue(v) / 1000; return s < 10 ? s.toFixed(1) + 's' : Math.round(s) + 's'; } }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 8 }, maxTicksLimit: 4 }
                        }
                    },
                    interaction: { enabled: false },
                    layout: { padding: { left: 0, right: 0, top: 0, bottom: 0 } }
                }
            });
        }

        const charts = {
            pitch: makeMiniChart('canvasPitch', '#4dabf7', false),
            torque: makeMiniChart('canvasTorque', '#ff6b6b', false),
            vel: makeMiniChart('canvasVel', '#51cf66', false),
            wpos: makeMiniChart('canvasWpos', '#fcc419', true)
        };

        function onTelemetry(event) {
            const dv = event.target.value;
            if (dv.byteLength < 13) return;
            const pitch = dv.getInt16(0, true) / 100;
            const pitchRate = dv.getInt16(2, true) / 10;
            const wheelVel = dv.getInt16(4, true) / 10;
            const wheelPos = dv.getInt16(6, true) / 100;
            const torque = dv.getInt16(8, true) / 100;
            const dtUs = dv.getUint16(10, true);
            const flags = dv.getUint8(12);

            mcuTimeMs += dtUs / 1000;
            livePitch.textContent = pitch.toFixed(2) + '\u00B0';
            liveTorque.textContent = torque.toFixed(2) + 'V';
            liveVel.textContent = wheelVel.toFixed(1);
            liveWpos.textContent = wheelPos.toFixed(1);
            chartDt.textContent = 'dt ' + dtUs + '\u00B5s';
            chartPitchEl.classList.toggle('saturated', (flags & 0x01) !== 0);

            const values = { pitch, torque, vel: wheelVel, wpos: wheelPos };
            Object.entries(charts).forEach(([key, c]) => {
                c.data.labels.push(mcuTimeMs);
                c.data.datasets[0].data.push(values[key]);
                if (c.data.labels.length > MAX_POINTS) {
                    c.data.labels.shift();
                    c.data.datasets[0].data.shift();
                }
                c.update();
            });
        }

        function clearChart() {
            mcuTimeMs = 0;
            Object.values(charts).forEach(c => {
                c.data.labels = [];
                c.data.datasets[0].data = [];
                c.update();
            });
            livePitch.textContent = '--';
            liveTorque.textContent = '--';
            liveVel.textContent = '--';
            liveWpos.textContent = '--';
            chartDt.textContent = '';
            chartPitchEl.classList.remove('saturated');
        }

        // ==================== TUNER BLE ====================
        let _gattBusy = false;
        async function sendCmd(cmd) {
            if (!charCmd || _gattBusy) return;
            _gattBusy = true;
            try {
                await charCmd.writeValue(new TextEncoder().encode(cmd));
            } catch (e) {
                showError('Send failed: ' + e.message);
            } finally {
                _gattBusy = false;
            }
        }

        let lastPitch = null, lastOffset = null;
        let statusResolve = null;

        function updateSlidersFromData(data) {
            if (data.P !== undefined) { sliders.kpPitch.el.value = data.P; sliders.kpPitch.val.textContent = data.P.toFixed(2); }
            if (data.I !== undefined) { sliders.kiPitch.el.value = data.I; sliders.kiPitch.val.textContent = data.I.toFixed(3); }
            if (data.D !== undefined) { sliders.kdPitch.el.value = data.D; sliders.kdPitch.val.textContent = data.D.toFixed(2); }
            if (data.p !== undefined) { sliders.kpVel.el.value = data.p; sliders.kpVel.val.textContent = data.p.toFixed(2); }
            if (data.i !== undefined) { sliders.kiVel.el.value = data.i; sliders.kiVel.val.textContent = data.i.toFixed(3); }
            if (data.d !== undefined) { sliders.kdVel.el.value = data.d; sliders.kdVel.val.textContent = data.d.toFixed(2); }
            if (data.T !== undefined) { sliders.maxTorque.el.value = data.T; sliders.maxTorque.val.textContent = data.T.toFixed(1); }
            if (data.S !== undefined) { sliders.slew.el.value = data.S; sliders.slew.val.textContent = data.S.toFixed(0); }
            if (data.h !== undefined) { sliders.posKp.el.value = data.h; sliders.posKp.val.textContent = data.h.toFixed(3); }
            if (data.G !== undefined) { sliders.steerGain.el.value = data.G; sliders.steerGain.val.textContent = data.G.toFixed(2); }
            if (data.C !== undefined) { sliders.ctrlFreq.el.value = data.C; sliders.ctrlFreq.val.textContent = data.C.toFixed(0); }
            if (data.pitch !== undefined) lastPitch = data.pitch;
            if (data.offset !== undefined) lastOffset = data.offset;
        }

        function onStatusNotify(event) {
            try {
                const data = JSON.parse(new TextDecoder().decode(event.target.value));
                updateSlidersFromData(data);
                if (statusResolve) { statusResolve(data); statusResolve = null; }
            } catch (e) { }
        }

        function waitForStatusNotify(timeoutMs = 1500) {
            return new Promise(resolve => {
                statusResolve = resolve;
                setTimeout(() => { statusResolve = null; resolve(null); }, timeoutMs);
            });
        }

        async function readStatus() {
            if (!charStatus) return;
            try {
                const raw = await charStatus.readValue();
                const text = new TextDecoder().decode(raw);
                const data = JSON.parse(text);
                updateSlidersFromData(data);
            } catch (e) {
                console.warn('readStatus failed:', e);
                showError('readStatus: ' + e.message);
            }
        }

        Object.entries(sliders).forEach(([k, s]) => {
            s.el.addEventListener('input', () => s.val.textContent = parseFloat(s.el.value).toFixed(s.fmt));
            s.el.addEventListener('change', () => sendCmd(s.cmd + s.el.value));
        });

        const zeroInfo = document.getElementById('zeroInfo');
        zeroBtn.addEventListener('click', async () => {
            zeroBtn.textContent = 'OK!';
            const notifyPromise = waitForStatusNotify(1500);
            await sendCmd('z0');
            const data = await notifyPromise;
            if (data && data.offset !== undefined) {
                zeroInfo.textContent = `ZERO SET \u2014 OFFSET: ${data.offset.toFixed(2)}\u00B0` +
                    (data.pitch !== undefined ? ` | PITCH: ${data.pitch.toFixed(2)}\u00B0` : '');
            } else {
                await readStatus();
                if (lastOffset !== null) {
                    zeroInfo.textContent = `ZERO SET \u2014 OFFSET: ${lastOffset.toFixed(2)}\u00B0` +
                        (lastPitch !== null ? ` | PITCH: ${lastPitch.toFixed(2)}\u00B0` : '');
                } else {
                    zeroInfo.textContent = 'ZERO SET';
                }
            }
            zeroInfo.style.display = 'block';
            setTimeout(() => { zeroBtn.textContent = 'Zero'; }, 1500);
        });

        function setupMoveBtn(btn, pressCmd) {
            let interval = null;
            function press() {
                if (btn.disabled) return;
                sendCmd(pressCmd);
                btn.classList.add('active');
                if (interval) clearInterval(interval);
                interval = setInterval(() => sendCmd(pressCmd), 200);
            }
            function release() {
                if (interval) { clearInterval(interval); interval = null; }
                sendCmd('x');
                btn.classList.remove('active');
            }
            btn.addEventListener('mousedown', press);
            btn.addEventListener('mouseup', release);
            btn.addEventListener('mouseleave', release);
            btn.addEventListener('touchstart', e => { e.preventDefault(); press(); });
            btn.addEventListener('touchend', e => { e.preventDefault(); release(); });
        }

        setupMoveBtn(btnFwd, 'f');
        setupMoveBtn(btnBack, 'b');
        setupMoveBtn(btnLeft, 'l');
        setupMoveBtn(btnRight, 'r');
        btnStop.addEventListener('click', () => sendCmd('x'));
        teleplotToggle.addEventListener('change', () => sendCmd('t0'));

        // ==================== BLE CONNECT (shared) ====================
        connectBtn.addEventListener('click', async () => {
            if (device && device.gatt.connected) { device.gatt.disconnect(); return; }
            try {
                updateStatus('SCAN...', false);
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'BalanceBot' }, { namePrefix: 'Balance' }, { services: [SERVICE_UUID] }],
                    optionalServices: [SERVICE_UUID, OTA_SERVICE_UUID]
                });
                device.addEventListener('gattserverdisconnected', onDisconnected);
                updateStatus('LINK...', false);
                const server = await device.gatt.connect();

                // Tuner service
                const service = await server.getPrimaryService(SERVICE_UUID);
                charCmd = await service.getCharacteristic(CHAR_CMD_UUID);
                charStatus = await service.getCharacteristic(CHAR_STATUS_UUID);
                charData = await service.getCharacteristic(CHAR_DATA_UUID);
                await charData.startNotifications();
                charData.addEventListener('characteristicvaluechanged', onTelemetry);
                await charStatus.startNotifications();
                charStatus.addEventListener('characteristicvaluechanged', onStatusNotify);

                // OTA service (optional)
                otaHasService = false;
                try {
                    const otaService = await server.getPrimaryService(OTA_SERVICE_UUID);
                    otaControlChar = await otaService.getCharacteristic(OTA_CONTROL_CHAR_UUID);
                    otaDataChar = await otaService.getCharacteristic(OTA_DATA_CHAR_UUID);
                    otaHasService = true;
                    otaLog('OTA service ready', 'success');
                } catch (e) {
                    otaLog('OTA service not available on this device', 'info');
                }

                clearChart();
                await readStatus();
                updateStatus('ONLINE', true);
                connectBtn.textContent = 'Disconnect';
                enableControls(true);
                updateOtaUI();
            } catch (e) {
                showError('Connection failed: ' + e.message);
                updateStatus('OFFLINE', false);
                connectBtn.textContent = 'Connect';
            }
        });

        function onDisconnected() {
            updateStatus('OFFLINE', false);
            connectBtn.textContent = 'Connect';
            enableControls(false);
            device = null; charCmd = null; charStatus = null; charData = null;
            otaControlChar = null; otaDataChar = null; otaHasService = false;
            otaUploading = false;
            updateOtaUI();
        }

        // ==================== OTA ====================
        const otaFileDrop = document.getElementById('otaFileDrop');
        const otaFileInput = document.getElementById('otaFileInput');
        const otaFileText = document.getElementById('otaFileText');
        const otaFileName = document.getElementById('otaFileName');
        const otaUploadBtn = document.getElementById('otaUploadBtn');
        const otaProgressContainer = document.getElementById('otaProgressContainer');
        const otaProgressBar = document.getElementById('otaProgressBar');
        const otaProgressText = document.getElementById('otaProgressText');
        const otaLogEl = document.getElementById('otaLog');

        let otaFirmwareData = null;
        let otaUploading = false;

        function updateOtaUI() {
            otaUploadBtn.disabled = !otaHasService || !otaFirmwareData || otaUploading;
        }

        function otaLog(msg, type = '') {
            const entry = document.createElement('div');
            entry.className = 'ota-log-entry ' + type;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${msg}`;
            otaLogEl.appendChild(entry);
            otaLogEl.scrollTop = otaLogEl.scrollHeight;
        }

        function otaSetProgress(percent) {
            otaProgressBar.style.width = percent + '%';
            otaProgressText.textContent = percent + '%';
        }

        // File selection
        otaFileDrop.addEventListener('click', () => otaFileInput.click());
        otaFileDrop.addEventListener('dragover', e => { e.preventDefault(); otaFileDrop.classList.add('dragover'); });
        otaFileDrop.addEventListener('dragleave', () => otaFileDrop.classList.remove('dragover'));
        otaFileDrop.addEventListener('drop', e => {
            e.preventDefault();
            otaFileDrop.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) loadOtaFile(e.dataTransfer.files[0]);
        });
        otaFileInput.addEventListener('change', () => {
            if (otaFileInput.files.length > 0) loadOtaFile(otaFileInput.files[0]);
        });

        function loadOtaFile(file) {
            if (!file.name.endsWith('.bin')) {
                otaLog('Please select a .bin file', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                otaFirmwareData = new Uint8Array(e.target.result);
                otaFileText.textContent = file.name;
                otaFileName.textContent = (otaFirmwareData.length / 1024).toFixed(1) + ' KB';
                otaFileDrop.classList.add('has-file');
                otaLog(`File: ${file.name} (${otaFirmwareData.length} bytes)`, 'info');
                updateOtaUI();
            };
            reader.readAsArrayBuffer(file);
        }

        // OTA upload
        otaUploadBtn.addEventListener('click', startOta);

        async function startOta() {
            if (!otaControlChar || !otaDataChar || !otaFirmwareData) return;

            otaUploading = true;
            updateOtaUI();
            otaProgressContainer.style.display = '';
            otaSetProgress(0);

            try {
                // BEGIN command with firmware size (little-endian)
                const beginCmd = new Uint8Array(5);
                beginCmd[0] = OTA_CMD_BEGIN;
                beginCmd[1] = otaFirmwareData.length & 0xFF;
                beginCmd[2] = (otaFirmwareData.length >> 8) & 0xFF;
                beginCmd[3] = (otaFirmwareData.length >> 16) & 0xFF;
                beginCmd[4] = (otaFirmwareData.length >> 24) & 0xFF;

                otaLog(`Starting OTA: ${otaFirmwareData.length} bytes`, 'info');
                await otaControlChar.writeValueWithResponse(beginCmd);
                await sleep(500);

                // Send firmware data in chunks
                const totalChunks = Math.ceil(otaFirmwareData.length / OTA_CHUNK_SIZE);
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * OTA_CHUNK_SIZE;
                    const end = Math.min(start + OTA_CHUNK_SIZE, otaFirmwareData.length);
                    const chunk = otaFirmwareData.slice(start, end);

                    await otaDataChar.writeValueWithResponse(chunk);

                    const percent = Math.round(((i + 1) / totalChunks) * 100);
                    otaSetProgress(percent);

                    if (percent % 10 === 0 && percent !== 100) {
                        otaLog(`Uploading... ${percent}%`, 'info');
                    }
                }

                otaLog('All data sent. Finalizing...', 'info');
                await sleep(500);

                // END command
                await otaControlChar.writeValueWithResponse(new Uint8Array([OTA_CMD_END]));

                otaLog('OTA complete! Device will reboot.', 'success');
                otaSetProgress(100);

            } catch (e) {
                otaLog(`OTA failed: ${e.message}`, 'error');
                otaSetProgress(0);

                try {
                    await otaControlChar.writeValueWithResponse(new Uint8Array([OTA_CMD_ABORT]));
                } catch (_) { }
            }

            otaUploading = false;
            updateOtaUI();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==================== PROFILES ====================
        const PROF_STORAGE_KEY = 'balancebot_profiles';
        const profList = document.getElementById('profList');
        const profSaveForm = document.getElementById('profSaveForm');
        const profNameInput = document.getElementById('profName');
        const profDescInput = document.getElementById('profDesc');

        function getProfiles() {
            try { return JSON.parse(localStorage.getItem(PROF_STORAGE_KEY)) || []; }
            catch { return []; }
        }

        function saveProfiles(profiles) {
            localStorage.setItem(PROF_STORAGE_KEY, JSON.stringify(profiles));
        }

        function getCurrentParams() {
            const params = {};
            Object.entries(sliders).forEach(([k, s]) => {
                params[s.cmd] = parseFloat(s.el.value);
            });
            return params;
        }

        function showSaveForm() {
            profSaveForm.classList.add('show');
            profNameInput.value = '';
            profDescInput.value = '';
            profNameInput.focus();
        }

        function hideSaveForm() {
            profSaveForm.classList.remove('show');
        }

        function saveProfile() {
            const name = profNameInput.value.trim();
            if (!name) { profNameInput.focus(); return; }
            const profiles = getProfiles();
            profiles.unshift({
                name,
                desc: profDescInput.value.trim(),
                ts: Date.now(),
                params: getCurrentParams()
            });
            saveProfiles(profiles);
            hideSaveForm();
            renderProfiles();
        }

        function deleteProfile(index) {
            const profiles = getProfiles();
            profiles.splice(index, 1);
            saveProfiles(profiles);
            renderProfiles();
        }

        const profActive = document.getElementById('profActive');
        const profToast = document.getElementById('profToast');

        function showProfileToast(msg) {
            profToast.textContent = msg;
            profToast.classList.add('show');
            setTimeout(() => profToast.classList.remove('show'), 2000);
        }

        async function loadProfile(index) {
            const profiles = getProfiles();
            const prof = profiles[index];
            if (!prof) return;

            // Update sliders UI
            Object.entries(sliders).forEach(([k, s]) => {
                if (prof.params[s.cmd] !== undefined) {
                    s.el.value = prof.params[s.cmd];
                    s.val.textContent = parseFloat(prof.params[s.cmd]).toFixed(s.fmt);
                }
            });

            // Show active profile name
            profActive.textContent = prof.name;
            profActive.style.display = '';

            // Highlight loading item
            const items = profList.querySelectorAll('.prof-item');
            if (items[index]) items[index].classList.add('loading');

            // Send to robot sequentially
            if (charCmd) {
                for (const [cmd, val] of Object.entries(prof.params)) {
                    while (_gattBusy) await sleep(30);
                    _gattBusy = true;
                    try {
                        await charCmd.writeValue(new TextEncoder().encode(cmd + val));
                    } catch (e) { }
                    _gattBusy = false;
                    await sleep(80);
                }
                showProfileToast('PROFILE LOADED  READY');
            } else {
                showProfileToast('PROFILE LOADED (OFFLINE)');
            }

            setTimeout(() => {
                if (items[index]) items[index].classList.remove('loading');
            }, 500);
        }

        function renderProfiles() {
            const profiles = getProfiles();
            if (profiles.length === 0) {
                profList.innerHTML = '<div class="prof-empty">No saved profiles</div>';
                return;
            }
            profList.innerHTML = profiles.map((p, i) => `
                <div class="prof-item">
                    <div class="prof-item-name">${esc(p.name)}</div>
                    ${p.desc ? `<div class="prof-item-desc">${esc(p.desc)}</div>` : ''}
                    <div class="prof-item-actions">
                        <button class="tbtn" style="background:linear-gradient(135deg,#198754,#20c997);color:white" onclick="loadProfile(${i})">Load</button>
                        <button class="tbtn" style="background:rgba(220,53,69,0.2);color:#dc3545;border:1px solid rgba(220,53,69,0.3)" onclick="deleteProfile(${i})">Del</button>
                    </div>
                </div>
            `).join('');
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // Enter key to save
        profNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') saveProfile(); });

        renderProfiles();
    </script>
</body>

</html>
